{
 "add_total_row": 1,
 "add_translate_data": 0,
 "columns": [
  {
   "fieldname": "customer",
   "fieldtype": "Link",
   "label": "Customer",
   "options": "Customer",
   "width": 100
  },
  {
   "fieldname": "customer_name",
   "fieldtype": "Data",
   "label": "Customer Name",
   "options": "",
   "width": 250
  },
  {
   "fieldname": "customer_group",
   "fieldtype": "Link",
   "label": "Customer Group",
   "options": "Customer Group",
   "width": 150
  },
  {
   "fieldname": "sales_qty",
   "fieldtype": "Int",
   "label": "Sales Qty",
   "width": 120
  },
  {
   "fieldname": "sales_amount",
   "fieldtype": "Currency",
   "label": "Sales Amount",
   "width": 150
  },
  {
   "fieldname": "cogs",
   "fieldtype": "Currency",
   "label": "Sales Cost",
   "width": 150
  },
  {
   "fieldname": "markup",
   "fieldtype": "Data",
   "label": "Profit %",
   "width": 100
  },
  {
   "fieldname": "balance_wo_so",
   "fieldtype": "Currency",
   "label": "Balance (w/o Orders)",
   "width": 150
  },
  {
   "fieldname": "orders_to_bill",
   "fieldtype": "Currency",
   "label": "Orders To Bill",
   "width": 150
  },
  {
   "fieldname": "balance_w_so",
   "fieldtype": "Currency",
   "label": "Balance Incl. Orders",
   "width": 150
  }
 ],
 "creation": "2026-02-12 09:47:30.049126",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [
  {
   "fieldname": "from_date",
   "fieldtype": "Date",
   "label": "From Date",
   "mandatory": 1,
   "wildcard_filter": 0
  },
  {
   "fieldname": "to_date",
   "fieldtype": "Date",
   "label": "To Date",
   "mandatory": 1,
   "wildcard_filter": 0
  }
 ],
 "idx": 0,
 "is_standard": "Yes",
 "letter_head": "",
 "letterhead": null,
 "modified": "2026-02-12 09:48:48.363375",
 "modified_by": "Administrator",
 "module": "Libya Customizations",
 "name": "Customer Performance Report",
 "owner": "Administrator",
 "prepared_report": 0,
 "query": "WITH\ngl_entry AS (\n    SELECT party AS customer, SUM(debit) - SUM(credit) AS balance\n    FROM `tabGL Entry`\n    WHERE is_cancelled = 0\n      AND party_type = 'Customer' AND posting_date <= %(to_date)s\n    GROUP BY party\n),\nunbilled_so AS (\n\tSELECT so.customer,\n\t    IFNULL(SUM((soi.amount - soi.billed_amt) * so.grand_total / so.total), 0) AS unbilled_amount\n\tFROM `tabSales Order Item` soi\n\tINNER JOIN `tabSales Order` so ON soi.parent = so.name\n\tWHERE soi.docstatus = 1 AND so.docstatus = 1 AND so.status NOT IN ('Closed', 'Completed')\n\t  AND soi.amount - soi.billed_amt > 0 AND so.transaction_date <= %(to_date)s\n    GROUP BY so.customer\n),\nsales AS (\n    SELECT si.customer,\n        SUM(si_item.qty) AS qty,\n        SUM(si_item.net_amount) AS net_amount\n    FROM `tabSales Invoice Item` si_item\n    INNER JOIN `tabSales Invoice` si\n    ON si_item.parent = si.name\n    WHERE si_item.docstatus = 1\n      AND si.docstatus = 1 AND si.posting_date BETWEEN %(from_date)s AND %(to_date)s\n    GROUP BY si.customer\n),\nsi_dn AS (\n    SELECT name, customer\n    FROM `tabSales Invoice`\n    WHERE docstatus = 1 AND update_stock = 1\n      AND posting_date BETWEEN %(from_date)s AND %(to_date)s\n    UNION\n    SELECT name, customer\n    FROM `tabDelivery Note`\n    WHERE docstatus = 1\n      AND posting_date BETWEEN %(from_date)s AND %(to_date)s\n),\ncogs AS (\n    SELECT si_dn.customer, SUM(stock_value_difference) * -1 AS cost\n    FROM `tabStock Ledger Entry` sle\n    INNER JOIN si_dn ON sle.voucher_no = si_dn.name\n    WHERE is_cancelled = 0 AND voucher_type IN ('Sales Invoice', 'Delivery Note')\n        AND posting_date BETWEEN %(from_date)s AND %(to_date)s\n    GROUP BY si_dn.customer\n)\nSELECT\n\tc.name AS customer,\n\tc.customer_name,\n\tc.customer_group,\n\tIFNULL(sales.qty, 0) AS sales_qty,\n\tIFNULL(sales.net_amount, 0) AS sales_amt,\n    IFNULL(cogs.cost, 0) AS cogs,\n    CONCAT(FORMAT(ROUND((IFNULL(sales.net_amount, 0) - IFNULL(cogs.cost, 0)) / IFNULL(sales.net_amount, 0) * 100, 1), 1), '%%') AS gpm,\n\tIFNULL(gle.balance, 0) AS balance_wo_so,\n\tIFNULL(unbilled_so.unbilled_amount, 0) AS orders_to_bill,\n\tIFNULL(gle.balance, 0) + IFNULL(unbilled_so.unbilled_amount, 0) AS balance_w_so\nFROM `tabCustomer` c\nLEFT JOIN gl_entry gle ON c.name = gle.customer\nLEFT JOIN unbilled_so ON c.name = unbilled_so.customer\nLEFT JOIN sales ON c.name = sales.customer\nLEFT JOIN cogs ON c.name = cogs.customer\nWHERE ABS(IFNULL(sales.qty, 0))\n    + ABS(IFNULL(sales.net_amount, 0))\n    + ABS(IFNULL(cogs.cost, 0))\n    + ABS(IFNULL(gle.balance, 0))\n    + IFNULL(unbilled_so.unbilled_amount, 0) > 0\nORDER BY\n\tABS(IFNULL(sales.net_amount, 0)) DESC, ABS(IFNULL(gle.balance, 0)) DESC",
 "ref_doctype": "Customer",
 "report_name": "Customer Performance Report",
 "report_type": "Query Report",
 "roles": [
  {
   "role": "System Manager"
  },
  {
   "role": "Chief Executive Officer"
  }
 ],
 "timeout": 0
}