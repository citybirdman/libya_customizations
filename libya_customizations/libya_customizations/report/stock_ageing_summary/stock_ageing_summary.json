{
 "add_total_row": 1,
 "add_translate_data": 0,
 "columns": [
  {
   "fieldname": "item_code",
   "fieldtype": "Data",
   "label": "Item Code",
   "width": 100
  },
  {
   "fieldname": "item_name",
   "fieldtype": "Data",
   "label": "Item Name",
   "width": 250
  },
  {
   "fieldname": "item_group",
   "fieldtype": "Link",
   "label": "Item Group",
   "options": "Item Group",
   "width": 130
  },
  {
   "fieldname": "origin",
   "fieldtype": "Link",
   "label": "Origin",
   "options": "Country",
   "width": 130
  },
  {
   "fieldname": "brand",
   "fieldtype": "Link",
   "label": "Brand",
   "options": "Brand",
   "width": 130
  },
  {
   "fieldname": "actual_qty",
   "fieldtype": "Int",
   "label": "Balance Qty",
   "width": 150
  },
  {
   "fieldname": "valuation_rate",
   "fieldtype": "Currency",
   "label": "Cost Price",
   "width": 150
  },
  {
   "fieldname": "avg_age",
   "fieldtype": "Currency",
   "label": "Avg Age",
   "width": 150
  }
 ],
 "creation": "2026-01-16 23:20:11.372521",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [
  {
   "default": "Today",
   "fieldname": "to_date",
   "fieldtype": "Date",
   "label": "To Date",
   "mandatory": 1,
   "wildcard_filter": 0
  },
  {
   "default": "1",
   "fieldname": "min_age",
   "fieldtype": "Int",
   "label": "Minimum Age",
   "mandatory": 1,
   "wildcard_filter": 0
  }
 ],
 "idx": 0,
 "is_standard": "Yes",
 "letter_head": "almasar",
 "letterhead": null,
 "modified": "2026-01-16 23:25:18.962918",
 "modified_by": "Administrator",
 "module": "Libya Customizations",
 "name": "Stock Ageing Summary",
 "owner": "Administrator",
 "prepared_report": 0,
 "query": "WITH\nsle_receipt AS (\n    SELECT posting_date, item_code, actual_qty\n    FROM `tabLegacy Purchase Ledger`\n    UNION ALL\n    SELECT posting_date, item_code,\n        SUM(actual_qty) AS actual_qty\n    FROM `tabStock Ledger Entry`\n    WHERE is_cancelled = 0\n      AND actual_qty > 0 AND voucher_type IN ('Purchase Receipt', 'Purchase Invoice', 'Stock Entry')\n      AND voucher_no IN (\n      SELECT name FROM `tabPurchase Receipt` WHERE docstatus = 1 AND is_return = 0 AND posting_date <= %(to_date)s\n      UNION\n      SELECT name FROM `tabPurchase Invoice` WHERE docstatus = 1 AND is_return = 0 AND update_stock = 1 AND posting_date <= %(to_date)s\n      UNION\n      SELECT name FROM `tabStock Entry` WHERE docstatus = 1 AND stock_entry_type = 'Material Receipt' AND posting_date <= %(to_date)s\n      )\n      AND posting_date <= %(to_date)s\n    GROUP BY item_code, posting_date\n),\nsle_balance AS (\n    SELECT item_code, SUM(actual_qty) AS actual_qty,\n        SUM(stock_value_difference) / SUM(actual_qty) AS valuation_rate\n    FROM `tabStock Ledger Entry`\n    WHERE is_cancelled = 0\n      AND posting_date <= %(to_date)s\n    GROUP BY item_code\n    HAVING SUM(actual_qty) > 0\n),\nsle_receipt_rt AS (\n    SELECT sler.posting_date, sler.item_code, sler.actual_qty AS receipt_qty, sleb.actual_qty AS balance_qty,\n        SUM(sler.actual_qty) OVER (PARTITION BY sler.item_code ORDER BY sler.posting_date DESC) AS rt_receipt_qty\n    FROM sle_receipt sler\n    INNER JOIN sle_balance sleb ON sler.item_code = sleb.item_code\n    GROUP BY sler.item_code, sler.posting_date\n    ORDER BY sler.item_code, sler.posting_date DESC\n),\nageing_calculation AS (\n    SELECT posting_date, item_code,\n        IF(balance_qty<=0, 0,\n           IF(balance_qty>=rt_receipt_qty,receipt_qty,\n              IF(receipt_qty-(rt_receipt_qty-balance_qty)>0,receipt_qty-(rt_receipt_qty-balance_qty),0)\n           )\n        ) AS os_qty,\n        IF(\n           IF(balance_qty<=0,0,\n              IF(balance_qty>=rt_receipt_qty,receipt_qty,\n                 IF(receipt_qty-(rt_receipt_qty-balance_qty)>0,receipt_qty-(rt_receipt_qty-balance_qty),0)\n              )\n           ),\n        DATEDIFF(%(to_date)s, posting_date) + 1, 0) AS age\n    FROM sle_receipt_rt\n    WHERE IF(balance_qty<=0,0,\n             IF(balance_qty>=rt_receipt_qty,receipt_qty,\n                IF(receipt_qty-(rt_receipt_qty-balance_qty)>0,receipt_qty-(rt_receipt_qty-balance_qty),0)\n             )\n          ) > 0\n),\nageing_tab AS (\n    SELECT item_code,\n        SUM(os_qty * age) / SUM(os_qty) AS avg_age,\n        SUM(os_qty) AS balance_qty\n    FROM ageing_calculation\n    GROUP BY item_code\n)\nSELECT sleb.item_code, i.item_name, i.item_group,\n    i.country_of_origin AS origin, i.brand,\n    sleb.actual_qty, sleb.valuation_rate, at.avg_age\nFROM sle_balance sleb\nINNER JOIN `tabItem` i ON sleb.item_code = i.name\nLEFT JOIN ageing_tab at ON sleb.item_code = at.item_code\nLEFT JOIN `tabTire Size` ts ON i.tire_size = ts.name\nWHERE avg_age >= %(min_age)s\nORDER BY i.brand, IFNULL(ts.sorting_code, 'Z')",
 "ref_doctype": "Stock Ledger Entry",
 "report_name": "Stock Ageing Summary",
 "report_type": "Query Report",
 "roles": [
  {
   "role": "Sales Supervisor"
  },
  {
   "role": "Sales Coordinator"
  },
  {
   "role": "Chief Sales Officer"
  },
  {
   "role": "Stock User"
  }
 ],
 "timeout": 0
}